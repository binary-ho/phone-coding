# 핵심 로직 테스트 분석 보고서

본 문서는 현재 코드베이스에서 단위 테스트가 누락된 핵심 기능 및 로직을 식별하고, 향후 테스트 코드 작성을 위한 기반을 마련하기 위해 작성되었습니다.

현재 테스트는 `src/prompt.ts`의 `buildPrompt` 함수에 대해서만 존재하며, 다른 모든 모듈의 로직은 테스트 커버리지에서 제외되어 있습니다.

---

## 1. `src/context.ts`

이 모듈은 GitHub Action의 컨텍스트를 가져오고 코드 변경사항(`diff`)을 추출하는 중요한 역할을 합니다.

### `getPrContext` 함수

*   **중요성**: 이 함수는 액션이 올바른 Pull Request 컨텍스트에서 실행되는지를 보장하는 첫 번째 관문입니다. 잘못된 컨텍스트에서 실행될 경우, 액션은 비정상 종료되거나 다른 PR에 영향을 미칠 수 있습니다.
*   **테스트 시나리오**:
    *   `[ ]` **성공**: GitHub 컨텍스트에 `pull_request` 객체가 존재할 경우, `octokit.rest.pulls.get`을 모킹(mocking)하여 예상되는 PR 데이터 구조를 정확히 반환하는지 확인해야 합니다.
    *   `[ ]` **실패 (비 PR 컨텍스트)**: `github.context.payload.pull_request`가 `undefined`일 때, 함수가 `undefined`를 반환하여 액션이 정상적으로 중단되는지 확인해야 합니다.

### `getPrDiff` 함수

*   **중요성**: 코드 변경사항은 AI 모델에 전달되는 가장 중요한 정보입니다. 이 함수가 정확한 `diff`를 생성하지 못하면 AI의 분석 품질이 크게 저하됩니다.
*   **테스트 시나리오**:
    *   `[ ]` **명령어 호출 검증**: `@actions/exec` 모듈을 모킹하여, `exec.exec` 함수가 올바른 `git diff` 명령어와 함께 호출되는지 확인해야 합니다.
    *   `[ ]` **출력 캡처 검증**: `exec.exec`의 `listeners` 옵션을 시뮬레이션하여, `stdout`으로 출력되는 데이터가 정상적으로 문자열로 조합되어 반환되는지 확인해야 합니다.

---

## 2. `src/gemini.ts`

이 모듈은 Gemini API와의 모든 통신을 캡슐화합니다. API 연동 부분은 잠재적 오류 발생 가능성이 높아 테스트가 필수적입니다.

### `callGeminiApi` 함수

*   **중요성**: 액션의 핵심 기능인 AI 분석을 직접 수행하는 함수입니다. API 호출의 성공, 실패, 예외적인 응답에 모두 안정적으로 대응해야 합니다.
*   **테스트 시나리오**:
    *   `[ ]` **API 호출 성공**: `@google/genai` SDK를 모킹하여, API가 성공적으로 텍스트 응답을 반환하는 케이스를 시뮬레이션하고, 해당 텍스트가 정상적으로 반환되는지 확인해야 합니다.
    *   `[ ]` **API 응답이 비어있는 경우**: API 응답 객체에서 `text` 필드가 `undefined`일 때, 의도한 대로 "No text response from Gemini API" 에러를 발생시키는지 확인해야 합니다.
    *   `[ ]` **API 호출 실패**: SDK가 네트워크 오류 등으로 인해 에러를 발생시키는 경우, 해당 에러가 정상적으로 `catch` 되어 외부로 다시 던져지는지(re-throw) 확인해야 합니다.

---

## 3. `src/comment.ts`

이 모듈은 GitHub PR에 코멘트를 작성하고 업데이트하는 '고정 코멘트(sticky comment)' 전략의 핵심입니다. 이 로직에 문제가 생기면 PR이 코멘트로 넘쳐나는 등 사용자 경험을 크게 해칠 수 있습니다.

### `findPreviousComment` 함수

*   **중요성**: 기존 코멘트를 정확히 찾아야만 '생성'과 '업데이트'를 올바르게 분기할 수 있습니다.
*   **테스트 시나리오**:
    *   `[ ]` **코멘트 찾기 성공**: `octokit`을 모킹하여, 봇이 작성했고 고유 태그(`COMMENT_TAG`)를 포함하는 코멘트가 목록에 있을 때, 해당 코멘트 객체를 정확히 찾아내는지 확인해야 합니다.
    *   `[ ]` **코멘트 찾기 실패**: 조건에 맞는 코멘트가 없을 때 `undefined`를 반환하는지 확인해야 합니다.
    *   `[ ]` **페이지네이션**: `octokit.paginate`가 여러 페이지의 코멘트를 반환할 때도 코멘트를 정확히 찾아내는지 확인해야 합니다.

### `postOrUpdateComment` 함수

*   **중요성**: `findPreviousComment`의 결과에 따라 코멘트를 새로 생성할지, 기존 것을 업데이트할지를 결정하는 핵심 분기 로직입니다.
*   **테스트 시나리오**:
    *   `[ ]` **업데이트 경로**: `findPreviousComment`가 특정 코멘트 객체를 반환했다고 가정하고, `issues.updateComment`가 올바른 `comment_id`와 함께 호출되는지 확인해야 합니다.
    *   `[ ]` **생성 경로**: `findPreviousComment`가 `undefined`를 반환했다고 가정하고, `issues.createComment`가 올바른 `issue_number`와 함께 호출되는지 확인해야 합니다.
